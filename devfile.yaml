schemaVersion: 2.2.2
metadata:
  name: dotnet-restapi-multirepo
components:
  - name: tools
    container:
      image: quay.io/cgruver0/che/dot-net:ubi
      mountSources: true
      cpuRequest: 50m
      cpuLimit: 1000m
      memoryRequest: 1Gi
      memoryLimit: 4Gi
      env:
        - name: SHELL
          value: "/bin/zsh"
        - name: HOME
          value: "/projects/home"
        - name: VSCODE_DEFAULT_WORKSPACE
          value: "/projects/dotnet-restapi-multirepo/dotnet-restapi.code-workspace"
        - name: ASPNETCORE_URLS
          value: "http://0.0.0.0:5000"
      endpoints:
        - exposure: public
          name: debug
          protocol: https
          targetPort: 5000
        - exposure: public
          name: 'api-endpoint'
          protocol: https
          targetPort: 5154
          path: '/api/todoitems'
  - name: prep-workspace
    container:
      args:
        - '-c'
        - >-
          mkdir -p /projects/bin && cp /usr/bin/oc /projects/bin/oc && cp /usr/bin/kubectl /projects/bin/kubectl && if [[ -f ${HOME}/.kube/config ]]; then rm ${HOME}/.kube/config; fi
      command:
        - /bin/bash
      image: image-registry.openshift-image-registry.svc:5000/openshift/cli:latest
      mountSources: true
      sourceMapping: /projects
      memoryRequest: 128Mi
      memoryLimit: 256Mi
      cpuRequest: 10m
      cpuLimit: 200m
      env:
      - name: HOME
        value: "/projects/home"
  - name: sqlserver-container1
    attributes:
      container-overrides: 
        securityContext:
          capabilities:
            add:
              - NET_BIND_SERVICE
    container:
      image: mcr.microsoft.com/mssql/rhel/server:2022-CU17-rhel-9.1         
      memoryLimit: '2Gi'
      memoryRequest: '2Gi'
      env:
        - name: MSSQL_PID
          value: "Developer"
        - name: ACCEPT_EULA
          value: "Y"
        - name: MSSQL_SA_PASSWORD
          value: 'P@ssword1'
      volumeMounts:
        - name: mssql-db1
          path: /var/opt/mssql
      endpoints:
        - exposure: internal
          name: 'sqlsvr-1431'
          targetPort: 1431   
        - exposure: internal
          name: 'sqlsvr-1433'
          protocol: https
          targetPort: 1433
        - exposure: internal
          name: 'sqlsvr-1434'
          protocol: https
          targetPort: 1434
  - name: sqlserver-container2
    attributes:
      container-overrides: 
        securityContext:
          capabilities:
            add:
              - NET_BIND_SERVICE
    container:
      image: mcr.microsoft.com/mssql/rhel/server:2022-CU17-rhel-9.1         
      memoryLimit: '2Gi'
      memoryRequest: '2Gi'
      env:
        - name: MSSQL_PID
          value: "Developer"
        - name: ACCEPT_EULA
          value: "Y"
        - name: MSSQL_SA_PASSWORD
          value: 'P@ssw0rd1'
        - name: MSSQL_TCP_PORT
          value: "1437"
      volumeMounts:
        - name: mssql-db2
          path: /var/opt/mssql
      endpoints:
        - exposure: internal
          name: 'sqlsvr-1435'
          targetPort: 1435   
        - exposure: internal
          name: 'sqlsvr-1437'
          protocol: https
          targetPort: 1437
        - exposure: internal
          name: 'sqlsvr-1438'
          protocol: https
          targetPort: 1438
  - name: mssql-db1
    volume:
      size: 2Gi 
  - name: mssql-db2
    volume:
      size: 2Gi 
events:
  preStart:
    - prep-workspace
commands:
  - id: prep-workspace
    apply:
      component: prep-workspace
      label: Pre Start Prep
  - id: 1-update-dependencies
    exec:
      label: 1.Update dependencies
      component: tools
      workingDir: /projects/dotnet-restapi.1/src
      commandLine: "dotnet restore"
      group:
        kind: build

  - id: 2-build
    exec:
      label: 2.Build
      component: tools
      workingDir: /projects/dotnet-restapi.1/src
      commandLine: "dotnet build"
      group:
        kind: build
  - id: 3-test
    exec:
      label: 3.Test
      component: tools
      workingDir: /projects/dotnet-restapi.1/test
      commandLine: "dotnet test"
      group:
        kind: run
  - id: 4-run
    exec:
      label: 4.Run
      component: tools
      workingDir: /projects/dotnet-restapi.1/src
      commandLine: "dotnet run"
      group:
        kind: run
  - id: 5-run-live-mode
    exec:
      label: 5.Run (Hot Reload)
      component: tools
      workingDir: /projects/dotnet-restapi.1/src
      commandLine: "dotnet watch run"
      group:
        kind: run
  - id: 6-update-dependencies-api2
    exec:
      label: 6.Update dependencies
      component: tools
      workingDir: /projects/dotnet-restapi.2/src
      commandLine: "dotnet restore"
      group:
        kind: build

  - id: 7-build-api2
    exec:
      label: 7.Build
      component: tools
      workingDir: /projects/dotnet-restapi.2/src
      commandLine: "dotnet build"
      group:
        kind: build
  - id: 3-test
    exec:
      label: 3.Test
      component: tools
      workingDir: /projects/dotnet-restapi.1/test
      commandLine: "dotnet test"
      group:
        kind: run
  - id: 4-run
    exec:
      label: 4.Run
      component: tools
      workingDir: /projects/dotnet-restapi.1/src
      commandLine: "dotnet run"
      group:
        kind: run
  - id: 5-run-live-mode
    exec:
      label: 5.Run (Hot Reload)
      component: tools
      workingDir: /projects/dotnet-restapi.1/src
      commandLine: "dotnet watch run"
      group:
        kind: run
